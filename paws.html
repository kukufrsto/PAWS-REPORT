<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAWS Animal Cruelty Reporting System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .section-content {
            display: none; /* Hidden by default */
        }
        .section-content.active {
            display: block; /* Shown when active */
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hero-background {
            background-image: url('https://placehold.co/1200x600/E0F2F7/2E8B57?text=Protect+Animals'); /* Placeholder image for hero */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        /* Custom modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 80%;
            max-width: 500px;
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8">
    <!-- Main Container -->
    <div class="max-w-4xl w-full bg-white shadow-xl rounded-lg p-8 sm:p-10 lg:p-12">

        <!-- Header Section -->
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-green-700 mb-4">
                PAWS Reporting System
            </h1>
            <p class="text-lg text-gray-600">
                Streamlining animal cruelty reports in the Philippines
            </p>
        </header>

        <!-- Navigation -->
        <nav class="mb-10">
            <ul class="flex flex-wrap justify-center gap-4 text-center">
                <li>
                    <a href="#home" class="nav-link block px-5 py-3 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-300 shadow-md">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#register" class="nav-link block px-5 py-3 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-300 shadow-md">
                        Register
                    </a>
                </li>
                <li>
                    <a href="#login" class="nav-link block px-5 py-3 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-300 shadow-md">
                        Login
                    </a>
                </li>
                <li>
                    <a href="#file-report" class="nav-link block px-5 py-3 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-300 shadow-md">
                        File Report
                    </a>
                </li>
                <li>
                    <a href="#track-report" class="nav-link block px-5 py-3 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-300 shadow-md">
                        Track Report
                    </a>
                </li>
                <li>
                    <a href="#admin-panel" class="nav-link block px-5 py-3 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-300 shadow-md">
                        Admin Panel
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Homepage Section -->
        <section id="home" class="section-content active mb-12 p-6 bg-white rounded-lg shadow-inner">
            <div class="hero-background rounded-lg p-8 sm:p-10 lg:p-12 text-center text-white mb-8">
                <h2 class="text-4xl sm:text-5xl font-extrabold mb-4 drop-shadow-lg">
                    Report Animal Cruelty, Make a Difference!
                </h2>
                <p class="text-lg sm:text-xl mb-6 drop-shadow-md">
                    Your voice helps protect animals across the Philippines.
                </p>
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <a href="#file-report" class="nav-link inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                        File a Report Now
                    </a>
                    <a href="#track-report" class="nav-link inline-block bg-white text-green-700 hover:bg-gray-100 font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                        Track Your Report
                    </a>
                </div>
            </div>

            <div class="text-center mb-8">
                <h3 class="text-3xl font-bold text-gray-800 mb-4">About the PAWS Reporting System</h3>
                <p class="text-gray-700 leading-relaxed max-w-2xl mx-auto">
                    This web-based system is designed to streamline the reporting, tracking, and management of animal cruelty cases. It aims to bridge the gap between concerned citizens, the Philippine Animal Welfare Society (PAWS), and local authorities, providing a centralized and efficient channel for reporting incidents and ensuring timely action.
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                <div class="p-4 bg-green-50 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold text-green-800 mb-2">Easy Reporting</h4>
                    <p class="text-gray-700">Submit detailed reports with optional multimedia evidence.</p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold text-green-800 mb-2">Real-time Tracking</h4>
                    <p class="text-gray-700">Monitor the status of your submitted cases effortlessly.</p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold text-green-800 mb-2">Admin Review</h4>
                    <p class="text-gray-700">Ensuring all reports are verified and escalated appropriately.</p>
                </div>
            </div>
        </section>

        <!-- Register Section -->
        <section id="register" class="section-content mb-12 p-6 bg-white rounded-lg shadow-inner">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Register Account</h2>
            <form id="register-form" class="space-y-6">
                <div>
                    <label for="reg-full-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" id="reg-full-name" name="fullName" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                </div>
                <div>
                    <label for="reg-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input type="email" id="reg-email" name="email" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                </div>
                <div>
                    <label for="reg-mobile" class="block text-sm font-medium text-gray-700 mb-1">Mobile Number</label>
                    <input type="tel" id="reg-mobile" name="mobileNumber" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                </div>
                <div>
                    <label for="reg-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="reg-password" name="password" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                </div>
                <div>
                    <label for="reg-confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                    <input type="password" id="reg-confirm-password" name="confirmPassword" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                </div>
                <button type="submit"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300">
                    Register
                </button>
            </form>
        </section>

        <!-- Login Section -->
        <section id="login" class="section-content mb-12 p-6 bg-white rounded-lg shadow-inner">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Login</h2>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input type="email" id="login-email" name="email" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-password" name="password" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                </div>
                <button type="submit"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300">
                    Login
                </button>
            </form>
        </section>

        <!-- File Report Section -->
        <section id="file-report" class="section-content mb-12 p-6 bg-white rounded-lg shadow-inner">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">File New Report</h2>
            <form id="file-report-form" class="space-y-6">
                <div>
                    <label for="report-type" class="block text-sm font-medium text-gray-700 mb-1">Type of Cruelty</label>
                    <select id="report-type" name="crueltyType" required
                            class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                        <option value="">Select a type</option>
                        <option value="physical-abuse">Physical Abuse</option>
                        <option value="neglect">Neglect</option>
                        <option value="abandonment">Abandonment</option>
                        <option value="hoarding">Hoarding</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="report-location" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                    <input type="text" id="report-location" name="location" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div>
                        <label for="report-date" class="block text-sm font-medium text-gray-700 mb-1">Date of Incident</label>
                        <input type="date" id="report-date" name="date" required
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="report-time" class="block text-sm font-medium text-gray-700 mb-1">Time of Incident</label>
                        <input type="time" id="report-time" name="time" required
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                    </div>
                </div>
                <div>
                    <label for="report-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="report-description" name="description" rows="5" required
                              class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm"></textarea>
                </div>
                <div>
                    <label for="report-evidence" class="block text-sm font-medium text-gray-700 mb-1">Image/Video Evidence (Optional)</label>
                    <input type="file" id="report-evidence" name="evidence" accept="image/*,video/*" multiple
                           class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                </div>
                <button type="submit"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300">
                    Submit Report
                </button>
            </form>
        </section>

        <!-- Track Report Status Section -->
        <section id="track-report" class="section-content mb-12 p-6 bg-white rounded-lg shadow-inner">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Track Report Status</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 rounded-lg shadow-md">
                    <thead class="bg-green-500">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider rounded-tl-lg">Report ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Type</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Location</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider rounded-tr-lg">Status</th>
                        </tr>
                    </thead>
                    <tbody id="user-reports-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Reports will be loaded here dynamically -->
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">No reports found or please log in.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Admin Review Panel Section -->
        <section id="admin-panel" class="section-content p-6 bg-white rounded-lg shadow-inner">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Admin Review Panel</h2>
            <div id="admin-reports-list" class="space-y-6">
                <!-- Admin report cards will be loaded here dynamically -->
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <p class="text-center text-gray-500">No reports found or only accessible by admin.</p>
                </div>
            </div>
        </section>

    </div>

    <!-- Custom Modal for Messages -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p id="modal-message" class="text-lg text-gray-800"></p>
            <button id="modal-close-btn" class="mt-4 px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-300">OK</button>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = {};
        const rawFirebaseConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';

        try {
            // Attempt to parse the firebase config from the environment variable
            const parsedConfig = JSON.parse(rawFirebaseConfig);
            // Use provided config, but ensure essential fields have fallbacks if missing
            firebaseConfig = {
                apiKey: "AIzaSyCM7z_CuTNe7ik_T8HASb9IkDHKQxBzZEE", // Explicitly set API Key from user's input
                authDomain: parsedConfig.authDomain || "paws-d9af6.firebaseapp.com", // Use user's project ID for authDomain
                projectId: "paws-d9af6", // Explicitly set Project ID from user's input
                storageBucket: parsedConfig.storageBucket || "paws-d9af6.appspot.com", // Use user's project ID for storageBucket
                messagingSenderId: parsedConfig.messagingSenderId || "8515431102", // Explicitly set Project Number from user's input
                appId: "1:8515431102:web:aaf8de9bb00e451b66ccef" // Updated App ID from user's input
            };
        } catch (e) {
            console.error("Error parsing __firebase_config, using dummy config:", e);
            // Fallback to a complete dummy config if parsing fails
            firebaseConfig = {
                apiKey: "AIzaSyCM7z_CuTNe7ik_T8HASb9IkDHKQxBzZEE", // Fallback API Key
                authDomain: "paws-d9af6.firebaseapp.com", // Fallback Auth Domain
                projectId: "paws-d9af6", // Fallback Project ID
                storageBucket: "paws-d9af6.appspot.com", // Fallback Storage Bucket
                messagingSenderId: "8515431102", // Fallback Messaging Sender ID
                appId: "1:8515431102:web:aaf8de9bb00e451b66ccef" // Fallback App ID
            };
        }

        console.log("Firebase Config being used:", firebaseConfig); // Log the final config
        console.log("Firebase API Key being used:", firebaseConfig.apiKey ? "Provided" : "Empty (expecting Canvas injection)");

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let isAdmin = false; // Flag to determine if the current user is an admin

        // --- Utility Functions for UI and Modals ---
        function showMessageModal(message) {
            const modal = document.getElementById('message-modal');
            const modalMessage = document.getElementById('modal-message');
            modalMessage.textContent = message;
            modal.style.display = 'flex'; // Use flex to center the modal content
        }

        function hideMessageModal() {
            const modal = document.getElementById('message-modal');
            modal.style.display = 'none';
        }

        // Close button for modal
        document.querySelector('.close-button').onclick = hideMessageModal;
        document.getElementById('modal-close-btn').onclick = hideMessageModal;
        window.onclick = function(event) {
            const modal = document.getElementById('message-modal');
            if (event.target == modal) {
                hideMessageModal();
            }
        }

        // --- Firebase Initialization and Authentication ---
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize Firebase app
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

                // Listen for auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User ID:", userId);

                        // Check if the user is an admin (e.g., from a 'admins' collection)
                        // In a real app, this would be more robust (e.g., custom claims)
                        const adminDocRef = doc(db, `artifacts/${appId}/public/data/admins`, userId);
                        const adminDocSnap = await getDoc(adminDocRef);
                        if (adminDocSnap.exists()) {
                            isAdmin = true;
                            console.log("User is an admin.");
                        } else {
                            isAdmin = false;
                            console.log("User is not an admin.");
                        }

                        // Load reports based on user role
                        if (isAdmin) {
                            loadAdminReports();
                        } else {
                            loadUserReports();
                        }
                    } else {
                        userId = null;
                        isAdmin = false;
                        console.log("No user signed in.");
                        // Clear reports if no user is signed in
                        document.getElementById('user-reports-table-body').innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No reports found or please log in.</td></tr>';
                        document.getElementById('admin-reports-list').innerHTML = '<div class="bg-white p-6 rounded-lg shadow-md border border-gray-200"><p class="text-center text-gray-500">No reports found or only accessible by admin.</p></div>';
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
                showMessageModal(`Error: ${error.message}`);
            }
        });

        // --- Navigation Logic ---
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.section-content');

        function showSection(id) {
            sections.forEach(section => {
                section.classList.remove('active');
            });
            const activeSection = document.getElementById(id);
            if (activeSection) {
                activeSection.classList.add('active');
            }

            // Trigger data load/refresh when navigating to specific sections
            if (id === 'track-report' && userId) {
                loadUserReports();
            } else if (id === 'admin-panel' && isAdmin) {
                loadAdminReports();
            }
        }

        // Handle navigation clicks
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault(); // Prevent default anchor behavior
                const targetId = this.getAttribute('href').substring(1); // Get section ID from href
                showSection(targetId);
                history.pushState(null, '', this.getAttribute('href')); // Update URL hash
            });
        });

        // Handle initial load and back/forward button
        function handleHashChange() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                showSection(hash);
            } else {
                showSection('home'); // Default to home if no hash
            }
        }

        window.addEventListener('hashchange', handleHashChange);

        // Initial section display based on URL hash or default to home
        handleHashChange();

        // --- User Authentication Functions ---
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fullName = document.getElementById('reg-full-name').value;
            const email = document.getElementById('reg-email').value;
            const mobileNumber = document.getElementById('reg-mobile').value;
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm-password').value;

            if (password !== confirmPassword) {
                showMessageModal("Passwords do not match.");
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // Store additional user info in Firestore
                await setDoc(doc(db, `artifacts/${appId}/users`, userCredential.user.uid), {
                    fullName: fullName,
                    email: email,
                    mobileNumber: mobileNumber,
                    createdAt: new Date()
                });
                showMessageModal("Registration successful! You can now log in.");
                document.getElementById('register-form').reset();
                showSection('login'); // Redirect to login after registration
            } catch (error) {
                console.error("Error registering user:", error);
                showMessageModal(`Registration failed: ${error.message}`);
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessageModal("Login successful!");
                document.getElementById('login-form').reset();
                showSection('home'); // Redirect to home or dashboard after login
            } catch (error) {
                console.error("Error logging in user:", error);
                showMessageModal(`Login failed: ${error.message}`);
            }
        });

        // --- Report Filing Function ---
        document.getElementById('file-report-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!userId) {
                showMessageModal("Please log in to file a report.");
                showSection('login');
                return;
            }

            const crueltyType = document.getElementById('report-type').value;
            const location = document.getElementById('report-location').value;
            const date = document.getElementById('report-date').value;
            const time = document.getElementById('report-time').value;
            const description = document.getElementById('report-description').value;
            const evidenceFiles = document.getElementById('report-evidence').files; // FileList object

            // In a real application, you would upload files to Firebase Storage first
            // and then store the download URLs in Firestore. For this example, we'll
            // just note that evidence is optional and not handle file uploads.
            let evidenceUrls = [];
            if (evidenceFiles.length > 0) {
                // Placeholder for file upload logic
                console.log("Evidence files selected:", evidenceFiles);
                showMessageModal("File uploads are not implemented in this demo. Report will be submitted without evidence files.");
            }

            try {
                const reportRef = await addDoc(collection(db, `artifacts/${appId}/public/data/reports`), {
                    userId: userId,
                    crueltyType: crueltyType,
                    location: location,
                    date: date,
                    time: time,
                    description: description,
                    evidenceUrls: evidenceUrls, // This would contain actual URLs after upload
                    status: 'Received', // Initial status
                    submittedAt: new Date()
                });
                showMessageModal(`Report filed successfully! Your Report ID is: ${reportRef.id}`);
                document.getElementById('file-report-form').reset();
                showSection('track-report'); // Redirect to track report
            } catch (error) {
                console.error("Error filing report:", error);
                showMessageModal(`Failed to file report: ${error.message}`);
            }
        });

        // --- Load User Reports ---
        async function loadUserReports() {
            if (!userId) {
                document.getElementById('user-reports-table-body').innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Please log in to view your reports.</td></tr>';
                return;
            }

            const reportsTableBody = document.getElementById('user-reports-table-body');
            reportsTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading reports...</td></tr>';

            try {
                // Query reports where userId matches the current user's ID
                // Note: Firestore security rules should enforce that users can only read their own reports
                const q = query(collection(db, `artifacts/${appId}/public/data/reports`), where("userId", "==", userId));

                onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        reportsTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No reports submitted yet.</td></tr>';
                        return;
                    }

                    reportsTableBody.innerHTML = ''; // Clear existing rows
                    snapshot.forEach((doc) => {
                        const report = doc.data();
                        const row = `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${doc.id}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${report.crueltyType}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${report.location}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${report.date}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm ${report.status === 'Resolved' ? 'text-green-600' : report.status === 'Under Review' ? 'text-yellow-600' : 'text-blue-600'} font-semibold">${report.status}</td>
                            </tr>
                        `;
                        reportsTableBody.innerHTML += row;
                    });
                });
            } catch (error) {
                console.error("Error loading user reports:", error);
                reportsTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error loading reports: ${error.message}</td></tr>`;
            }
        }

        // --- Load Admin Reports ---
        async function loadAdminReports() {
            if (!isAdmin) {
                document.getElementById('admin-reports-list').innerHTML = '<div class="bg-white p-6 rounded-lg shadow-md border border-gray-200"><p class="text-center text-gray-500">Access Denied: Only administrators can view this panel.</p></div>';
                return;
            }

            const adminReportsList = document.getElementById('admin-reports-list');
            adminReportsList.innerHTML = '<div class="bg-white p-6 rounded-lg shadow-md border border-gray-200"><p class="text-center text-gray-500">Loading admin reports...</p></div>';

            try {
                // Fetch all reports for admin view
                const q = query(collection(db, `artifacts/${appId}/public/data/reports`));

                onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        adminReportsList.innerHTML = '<div class="bg-white p-6 rounded-lg shadow-md border border-gray-200"><p class="text-center text-gray-500">No reports to review.</p></div>';
                        return;
                    }

                    adminReportsList.innerHTML = ''; // Clear existing cards
                    snapshot.forEach((doc) => {
                        const report = doc.data();
                        const reportId = doc.id;
                        const card = `
                            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-semibold text-gray-900">Report ID: ${reportId}</h3>
                                    <span class="px-3 py-1 ${report.status === 'New' ? 'bg-red-100 text-red-800' : report.status === 'Under Review' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'} text-sm font-medium rounded-full">${report.status}</span>
                                </div>
                                <p class="text-gray-700 mb-2"><span class="font-medium">User ID:</span> ${report.userId}</p>
                                <p class="text-gray-700 mb-2"><span class="font-medium">Type:</span> ${report.crueltyType}</p>
                                <p class="text-gray-700 mb-2"><span class="font-medium">Location:</span> ${report.location}</p>
                                <p class="text-gray-700 mb-2"><span class="font-medium">Date/Time:</span> ${report.date}, ${report.time}</p>
                                <p class="text-gray-700 mb-4"><span class="font-medium">Description:</span> ${report.description}</p>
                                <div class="flex flex-wrap gap-3">
                                    <select id="status-select-${reportId}" class="flex-1 min-w-[120px] py-2 px-4 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                                        <option value="Received" ${report.status === 'Received' ? 'selected' : ''}>Received</option>
                                        <option value="Under Review" ${report.status === 'Under Review' ? 'selected' : ''}>Under Review</option>
                                        <option value="Forwarded to Authorities" ${report.status === 'Forwarded to Authorities' ? 'selected' : ''}>Forwarded to Authorities</option>
                                        <option value="Resolved" ${report.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                                        <option value="Flagged/Malicious" ${report.status === 'Flagged/Malicious' ? 'selected' : ''}>Flagged/Malicious</option>
                                    </select>
                                    <button data-report-id="${reportId}" class="update-status-btn flex-1 min-w-[120px] py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition duration-300">
                                        Update Status
                                    </button>
                                </div>
                            </div>
                        `;
                        adminReportsList.innerHTML += card;
                    });

                    // Attach event listeners to update buttons after rendering
                    document.querySelectorAll('.update-status-btn').forEach(button => {
                        button.addEventListener('click', async (event) => {
                            const reportId = event.target.dataset.reportId;
                            const newStatus = document.getElementById(`status-select-${reportId}`).value;
                            await updateReportStatus(reportId, newStatus);
                        });
                    });
                });
            } catch (error) {
                console.error("Error loading admin reports:", error);
                adminReportsList.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md border border-gray-200"><p class="text-center text-red-500">Error loading reports: ${error.message}</p></div>`;
            }
        }

        // --- Update Report Status (Admin Function) ---
        async function updateReportStatus(reportId, newStatus) {
            if (!isAdmin) {
                showMessageModal("Permission Denied: You are not authorized to update report status.");
                return;
            }

            try {
                const reportRef = doc(db, `artifacts/${appId}/public/data/reports`, reportId);
                await updateDoc(reportRef, {
                    status: newStatus,
                    updatedAt: new Date()
                });
                showMessageModal(`Report ${reportId} status updated to: ${newStatus}`);
            } catch (error) {
                console.error("Error updating report status:", error);
                showMessageModal(`Failed to update status for report ${reportId}: ${error.message}`);
            }
        }
    </script>
</body>
</html>
